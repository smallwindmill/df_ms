/** 订单功能*/function verifyUse(str){    if(str){        return str;    }else{        return '';    }}const indent = (app,multipartMiddleware,fs,moment,connection,uploadFile, xlsx) =>{  var frontRequestUrl = "/produceMS";  // 上传excel文件新增订单  app.post(frontRequestUrl+'/uploadExcelForAddIndent', multipartMiddleware,function(req,res){      var file = req.files.file;      var userID = req.body.id;      var total=success=fail=0;      // console.log(file,req.body);      var nextFun = (file_path) =>{          var sheets = xlsx.parse(file_path);//获取到所有sheet          /*sheets.forEach(function(sheet){              console.log(sheet['name']);              for(var rowId in sheet['data']){                  var row=sheet['data'][rowId];                  if(row.length){                    console.log(rowId, row);                  }              }          });*/          var sheet = sheets[0];          for(let rowId in sheet['data']){              var row=sheet['data'][rowId];              if(rowId==0)continue;              var procedure = duty ='';              if(row.length){                // console.log(rowId, row);                var row_dir = row;                var sqlQuest0 = "select * from template where id = '"+row[row.length-1]+"'";                // 查询对应的模板是否存在                connection.query(sqlQuest0,function(error,res0){                  row = row_dir;                  // console.log(row);                  if(error){                    console.log(error);return;                  }                  if(res0.length){                    // console.log(res0[0].duty.split(' '));                    var procedureArr = res0[0].procedure.split(' ');                    var userArr = res0[0].duty.split(' ');                    total = procedureArr.length;                    // 添加订单记录                    for(let i = 0,len = procedureArr.length;i < len;i++){                      var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planOnline,actualStart,priority,ifNew,remark,templateID,`procedure`,duty,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                      // var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planOnline,actualStart,priority,ifNew,remark,templateID,procedure,duty,ifOutsource,feedback,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                      var sqlParam2 = [res0.name, row[0], row[1], row[2], row[3], row[4], row[5], row[6], row[7], row[8], row[9], row[10],procedureArr[i],userArr[i],0];                      connection.query(sqlQuest2,sqlParam2,function(error,res1){                        if(error){                          console.log(error);                          fail += 1;                        }else{                          // 添加流程记录                          // console.log(procedureArr, userArr, i);                          var sqlQuest3 = "insert into `procedure`(indentID, name, materialCode,materialName,duty,status) values(?, ?, ?, ?, ?, ?)";                          var sqlParam3 = [res1.insertId, procedureArr[i], row[2], row[3], userArr[i], 0];                          connection.query(sqlQuest3,sqlParam3,function(error,res1){                            if(error){                              console.log(error);                              fail += 1;                            }else{                              success+= 1;                            }                            if(i == procedureArr.length-1){                              console.log(procedureArr.length-1, i);                              res.send(JSON.stringify({code:200,'msg':'新增订单成功', results: {total: total,success: success, fail: fail,}}));                            }                          })                        }                      })                    }                  }                })              }          }      }      uploadFile.storageFile(file,fs,moment,connection,userID,nextFun);  })/*  // 删除订单信息  app.post(frontRequestUrl+'/deleteSystemUser',function(req,res){      var parse = req.body;      var sqlQuest = "delete from user where userID = '"+parse.userID+"'";      connection.query(sqlQuest,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'删除订单失败'}));          }else{              res.send(JSON.stringify({code:200,'msg':'删除订单成功'}));          }      })  })*/  // 获取所有订单列表(根据时间段查询、erp查询、id查询)  app.get([frontRequestUrl+'/listAllIndentByDate'],function(req,res){      var startDate = req.query.startDate?req.query.startDate:'';      var endDate = req.query.endDate?req.query.endDate:'';      var id = req.query.id?req.query.id:'';      var erp = req.query.erp?req.query.erp:'';      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      var sqlQuest = '';var sqlParam = '';      if(id){        sqlQuest = 'select * from indent where id=?';// where userName like "%'+userName+'%"';        sqlParam = [id]      }else if(erp){        sqlQuest = 'select * from indent where erp = ?';// where userName like "%'+userName+'%"';        sqlParam = [erp]      }else if(startDate){        sqlQuest = 'select * from indent where planOnline > ? and planOnline < ?';// where userName like "%'+userName+'%"';        sqlParam = [startDate, endDate];      }else{        sqlQuest = 'select * from indent';      }      connection.query(sqlQuest,sqlParam,function(error,res1,fileds){          console.log(sqlQuest, sqlParam);          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单数据失败',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:500,msg:'暂无订单信息',results:res1}));              }          }      })  })  // 获取所有订单列表(根据时间段查询)  /*app.get([frontRequestUrl+'/listAllIndentById'],function(req,res){      var userName = req.query.keyword?req.query.keyword:'';      var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      connection.query(sqlQuest,function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单数据失败',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:500,msg:'暂无订单信息',results:res1}));              }          }      })  })*/  // 更新订单信息  app.post(frontRequestUrl+'/updateIndentInfo',function(req,res){      var parse = req.body;      var sqlQuest = "update indent set planFinishDate = ?,planOnline = ?,actualFinish=?,priority=?,ifNew=?,ifOutsource=?,duty=?,status = ?, remark=? where id = ?";      // 需要mysql语句处理的字段，可以不必拼接，直接放入下面的自动拼接语句里      var sqlParam = [parse.planFinishDate, parse.planOnline, parse.actualFinish, parse.priority, parse.ifNew, parse.ifOutsource,parse.duty, parse.status, parse.remark, parse.id];      // console.log(sqlQuest, sqlParam);      connection.query(sqlQuest,sqlParam,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'更新订单失败'}));          }else{              res.send(JSON.stringify({code:200,'msg':'更新订单成功'}));          }      })  })  // 获取所有订单状态列表(根据时间段查询)  app.get([frontRequestUrl+'/listAllIndentStatusByDate', frontRequestUrl+'/listIndentById'],function(req,res){      var userName = req.query.keyword?req.query.keyword:'';      var startDate = req.query.startDate?req.query.startDate:'';      var endDate = req.query.endDate?req.query.endDate:'';      var id = req.query.id?req.query.id:'';      var erp = req.query.erp?req.query.erp:'';      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      var sqlQuest = '';var sqlParam = '';      if(id){        sqlQuest = 'select id,name,erp,materialCode,materialName,userName as duty,`procedure`, status from indent left join user on duty=user.userID where id = "'+req.query.id+'"';      }else if(erp){        sqlQuest = 'select id,name,erp,materialCode,materialName,userName as duty,`procedure`, status from indent left join user on duty=user.userID where erp = ?';        sqlParam = [erp];      }else if(startDate){        sqlQuest = 'select id,name,erp,materialCode,materialName,userName as duty,`procedure`, status from indent left join user on duty=user.userID where planOnline > ? and planOnline < ?';        sqlParam = [startDate, endDate];      }else{        sqlQuest = 'select * from indent';      }      console.log(sqlQuest);      connection.query(sqlQuest, sqlParam, function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单状态失败',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单状态成功',results:res1}));              }else{                  res.send(JSON.stringify({code:500,msg:'暂无订单信息',results:res1}));              }          }      })  })}module.exports = indent;