/** 订单功能*/function verifyUse(str){    if(str){        return str;    }else{        return '';    }}const indent = (app,multipartMiddleware,fs,moment,connection,uploadFile, xlsx) =>{  var frontRequestUrl = "/produceMS";  // 上传excel文件新增订单  app.post(frontRequestUrl+'/uploadExcelForAddIndent', multipartMiddleware,function(req,res){      var file = req.files.file;      var userID = req.body.id;      var total=success=fail=0;      // console.log(file,req.body);      var nextFun = (file_path) =>{          var sheets = xlsx.parse(file_path);//获取到所有sheet          /*sheets.forEach(function(sheet){              console.log(sheet['name']);              for(var rowId in sheet['data']){                  var row=sheet['data'][rowId];                  if(row.length){                    console.log(rowId, row);                  }              }          });*/          var sheet = sheets[0];          for(let rowId in sheet['data']){              var row=sheet['data'][rowId];              if(rowId==0)continue;              var procedure = duty ='';              if(row.length){                // console.log(rowId, row);                var row_dir = row;                var sqlQuest0 = "select * from template where id = '"+row[row.length-1]+"'";                // 查询对应的模板是否存在                connection.query(sqlQuest0,function(error,res0){                  row = row_dir;                  // console.log(row);                  if(error){                    console.log(error);return;                  }                  if(res0.length){                    // console.log(res0[0].duty.split(' '));                    var procedureArr = res0[0].procedure.split(' ');                    var userArr = res0[0].duty.split(' ');                    total = procedureArr.length;                    // 添加订单记录                    for(let i = 0,len = procedureArr.length;i < len-1;i++){                      var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planeOnline,actualStart,priority,ifNew,remark,templateID,`procedure`,duty,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                      // var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planeOnline,actualStart,priority,ifNew,remark,templateID,procedure,duty,ifOutsource,feedback,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                      var sqlParam2 = [row[row.length-1], row[0], row[1], row[2], row[3], row[4], row[5], row[6], row[7], row[8], row[9], row[10],procedureArr[i],userArr[i],0];                      connection.query(sqlQuest2,sqlParam2,function(error,res1){                        if(error){                          console.log(error);                          fail += 1;                        }else{                          // 添加流程记录                          console.log(procedureArr, userArr, i);                          var sqlQuest3 = "insert into `procedure`(indentID, name, materialCode,materialName,duty,status) values(?, ?, ?, ?, ?, ?)";                          var sqlParam3 = [res1.insertId, procedureArr[i], row[2], row[3], userArr[i], 0];                          connection.query(sqlQuest3,sqlParam3,function(error,res1){                            if(error){                              console.log(error);                              fail += 1;                            }else{                              success+= 1;                            }                          })                        }                      })                    }                  }                })              }          }          res.send(JSON.stringify({code:200,'msg':'新增订单成功', results: {total: total,success: success, fail: fail,}}));          return;      }      uploadFile.storageFile(file,fs,moment,connection,userID,nextFun);      return;      var sqlQuest05 = "select userName from user where userID in ("+res0[0].duty.split(' ')+")";      console.log(sqlQuest05);      // 查询负责人对应的姓名      connection.query(sqlQuest05,function(error,res0){        if(error){          console.log(error);        }else{          console.log(res0);          // 添加订单记录          for(var i = 0,len = res0.length;i < len;i++){            var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planeOnline,actualStart,status,priority,ifNew,ifOutsource,remark,feedback,templateID,procedure,duty) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";            var sqlParam2 = [parse.userID, parse.userName, parse.type, parse.pwd];            connection.query(sqlQuest2,sqlParam2,function(error,res1){              if(error){                console.log(error);                fail += 1;              }else{                // 添加流程记录                var sqlQuest3 = "insert into procedure(indentID, name,materialCode,materialName,procedure,duty,status) values(?, ?, ?, ?, ?, ?, ?)";                var sqlParam3 = [res1[0].id, parse.userName, parse.type, parse.pwd];                connection.query(sqlQuest3,sqlParam3,function(error,res1){                  if(error){                    console.log(error);                    fail += 1;                  }else{                    success+= 1;                  }                })              }            })          }          /*for(var i in res0){            var sqlQuest2 = "insert into indent(userID, userName,type,pwd) values(?, ?, ?, ?)";            var sqlParam2 = [parse.userID, parse.userName, parse.type, parse.pwd];            connection.query(sqlQuest2,sqlParam2,function(error,res1){              if(error){                console.log(error);                fail += 1;              }else{                success+= 1;              }            })          }*/        }      });      return;      // 新增订单      var sqlQuest = "insert into user(userID, userName,type,pwd) values(?, ?, ?, ?)";      var sqlParam = [parse.userID, parse.userName, parse.type, parse.pwd];      connection.query(sqlQuest,sqlParam,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'新增订单失败'}));          }else{              connection.query("select * from user where uid = ?",[res1.insertId],function(error,res2){                  if(error){                      console.log(error);                      res.send(JSON.stringify({code:500,'msg':'新增订单失败'}));                  }else{                      console.log(res1);                      res.send(JSON.stringify({code:200,'msg':'新增订单成功', results: res2[0]}));                  }              })          }      })  })/*  // 删除订单信息  app.post(frontRequestUrl+'/deleteSystemUser',function(req,res){      var parse = req.body;      var sqlQuest = "delete from user where userID = '"+parse.userID+"'";      connection.query(sqlQuest,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'删除订单失败'}));          }else{              res.send(JSON.stringify({code:200,'msg':'删除订单成功'}));          }      })  })*/  // 获取所有订单列表(根据时间段查询)  app.get([frontRequestUrl+'/listAllIndentByDate'],function(req,res){      var userName = req.query.keyword?req.query.keyword:'';      var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      connection.query(sqlQuest,function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单数据失败',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:500,msg:'无该订单信息',results:res1}));              }          }      })  })  // 更新订单信息  app.post(frontRequestUrl+'/updateIndentInfo',function(req,res){      var parse = req.body;      var sqlQuest = "update userPower set login=?,handleIndent=?,handleWorkhour=?,listIndent=?,captain=? where userID = ?";      // 需要mysql语句处理的字段，可以不必拼接，直接放入下面的自动拼接语句里      var sqlParam = [parse.login, parse.handleIndent, parse.handleWorkhour, parse.listIndent, parse.captain, parse.userID];      connection.query(sqlQuest,sqlParam,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'更新订单失败'}));          }else{              res.send(JSON.stringify({code:200,'msg':'更新订单成功'}));          }      })  })  // 文件上传  app.post('/CDTGIS/maporderdata/analyzeUploadFile',function(req,res){      res.setHeader("500");      res.send(JSON.stringify({code:200,msg:'sucess'}));  })}module.exports = indent;