/** 订单功能*/const indent = (app,multipartMiddleware,fs,moment,connection,uploadFile, xlsx) =>{  var frontRequestUrl = "/produceMS";  // 上传excel文件新增订单  app.post(frontRequestUrl+'/uploadExcelForAddIndent', multipartMiddleware,function(req,res){      var file = req.files.file;      var userID = req.body.id;      // console.log(file,req.body);      var nextFun = (file_path) =>{          var sheets = xlsx.parse(file_path);//获取到所有sheet          var sheet = sheets[0];          var total=success=fail=0;//数据统计          var importDataLen = sheet['data'].length - 1;          var totalError = {type:0, data:[], message:'的模板不存在'};          sheet['data'] = sheet['data'].filter(self=>{return self.length!=0});          for(let rowId in sheet['data']){              var row=sheet['data'][rowId];              if(rowId==0)continue;              var procedure = duty ='';              if(row.length){                // console.log(rowId, row);                var row_dir = row;                var sqlQuest0 = "select * from template where id = '"+row[row.length-1]+"'";                // 查询对应的模板是否存在              (function(row){                connection.query(sqlQuest0,function(error,res0){                  console.log('1',row);                  // row = row_dir;                  // console.log(row);                  if(error){                    console.log(error);totalError.data.push(row[row.length-1]);return;                  }                  if(res0.length){                    total++;                    // console.log(res0[0].duty.split(' '));                    var procedureArr = res0[0].procedure.split(' ');                    var userArr = res0[0].duty.split(' ');                    // 添加订单记录                    var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planOnline,actualStart,priority,ifNew,remark,templateID,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                    // var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planOnline,actualStart,priority,ifNew,remark,templateID,procedure,duty,ifOutsource,feedback,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                    var sqlParam2 = [res0.name, row[0], row[1], row[2], row[3], row[4].replace(/-/g,'.'), row[5].replace(/-/g,'.'), row[6].replace(/-/g,'.'), row[7].replace(/-/g,'.'), row[8], row[9], row[10],0];                    // 根据订单开始时间设置权重                      countFactor(row[6].replace(/-/g,'.'));                      connection.query(sqlQuest2,sqlParam2,function(error,res1){                        if(error){                          console.log(error);                        }else{                            // 添加流程记录                            for(let i = 0,len = procedureArr.length;i < len;i++){                              (function(rowId){                                var sqlQuest3 = "insert into `procedure`(indentID, name, materialCode,materialName,duty,status) values(?, ?, ?, ?, ?, ?)";                                // var sqlParam3 = [res1.insertId, procedureArr[i], row[2], row[3], userArr[i], 0];                                var sqlParam3 = [res1.insertId, procedureArr[i], row[1], row[2], userArr[i], 0];                                connection.query(sqlQuest3,sqlParam3,function(error,res1){                                  if(error){                                    console.log(error);                                  }else{                                  }                                    if(i == procedureArr.length-1){                                      success++;                                    }                                    if(rowId == sheet['data'].length-1){                                      if(i == procedureArr.length-1){                                        var info = totalError.data.length?('编号为'+totalError.data.join()+'的'+totalError.data.length+'个模板不存在，请检查重试'):''                                        res.send(JSON.stringify({code:200,'msg':'新增订单成功', results: {total: total,success: success, fail: fail,info: info}}));                                      }                                    }                                })                              })(rowId)                            }                          }                      })                  }                })             })(row)              }          }      }      uploadFile.storageFile(file,fs,moment,connection,userID,nextFun);  })  // 删除订单信息，用字段标识，不从数据库移除  app.post(frontRequestUrl+'/deleteIndent',function(req,res){      var parse = req.body;      var sqlQuest = "update indent set ifDelete= 1 where id='"+parse.id+"'";      connection.query(sqlQuest,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'删除订单失败'}));          }else{              res.send(JSON.stringify({code:200,'msg':'删除订单成功'}));          }      })  })  // 还原订单信息  app.post(frontRequestUrl+'/recycleIndent',function(req,res){      var parse = req.body;      var sqlQuest = "update indent set ifDelete= 0 where id='"+parse.id+"'";      connection.query(sqlQuest,function(error,res1){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,'msg':'还原订单失败'}));          }else{              res.send(JSON.stringify({code:200,'msg':'还原订单成功'}));          }      })  })  // 获取所有订单列表(根据时间段查询、erp查询、id查询)  app.get([frontRequestUrl+'/listAllIndentByDate', frontRequestUrl+'/listAllIndentById'],function(req,res){      var startDate = req.query.startDate?req.query.startDate:'';      var endDate = req.query.endDate?req.query.endDate:'';      var id = req.query.id?req.query.id:'';      var erp = req.query.erp?req.query.erp:'';      var ifDelete = req.query.ifDelete?req.query.ifDelete:0;      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      var sqlQuest = '';      var sqlParam = '';      /*if(id){        sqlQuest = 'select * from `procedure` a inner join indent b on a.indentID = b.id where b.id=? and ifDelete = ?';// where userName like "%'+userName+'%"';        sqlParam = [id, ifDelete];      }else if(erp){        sqlQuest = 'select * from `procedure` a inner join indent b on a.indentID = b.id where b.erp = ? and ifDelete = ?';// where userName like "%'+userName+'%"';        sqlParam = [erp, ifDelete];      }else if(startDate){        sqlQuest = 'select * from `procedure` a inner join indent b on a.indentID = b.id where (planOnline >= ? and planOnline <= ?) and ifDelete = ?';// where userName like "%'+userName+'%"';        sqlParam = [startDate.replace(/-/g,'.'), endDate.replace(/-/g,'.'), ifDelete];      }else{        sqlQuest = 'select *,a.status as status from `procedure` a inner join indent b on a.indentID = b.id and ifDelete = ?';        sqlParam = [ifDelete];      }*/      if(id){        sqlQuest = 'select * from indent  where id=? and ifDelete = ?';// where userName like "%'+userName+'%"';        sqlParam = [id, ifDelete];      }else if(erp){        sqlQuest = 'select * from indent  where erp = ? and ifDelete = ?';// where userName like "%'+userName+'%"';        sqlParam = [erp, ifDelete];      }else if(startDate){        sqlQuest = 'select * from indent  where (planOnline >= ? and planOnline <= ?) and ifDelete = ?';// where userName like "%'+userName+'%"';        sqlParam = [startDate.replace(/-/g,'.'), endDate.replace(/-/g,'.'), ifDelete];      }else{        sqlQuest = 'select * from indent  where ifDelete = ?';        sqlParam = [ifDelete];      }      connection.query(sqlQuest,sqlParam,function(error,res1,fileds){          // console.log(sqlQuest, sqlParam);          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单数据失败',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:200,msg:'暂无订单信息',results:res1}));              }          }      })  })  // 获取订单及对应流程表  app.get([frontRequestUrl+'/listIndentMatchTemplete'],function(req,res){      // var sqlQuest = 'select a.erp, a.materialCode, materialName, b.name ,GROUP_CONCAT(b.`procedure`) as `procedure`,GROUP_CONCAT(b.duty) as `duty` from indent a INNER JOIN template b where templateID = b.id and a.ifDelete = 0 GROUP BY a.id ORDER BY a.id';      var sqlQuest = "select a.erp, a.materialCode, materialName, b.name ,b.`procedure`, b.duty from indent a INNER JOIN (select template.id,template.name, template.procedure,replace(GROUP_CONCAT(userName),',',' ') as duty  from template,user where duty like CONCAT('%',userID,'%') and  ifDelete = 0 GROUP BY template.id) b where templateID = b.id and a.ifDelete = 0 GROUP BY a.id ORDER BY a.id";      connection.query(sqlQuest,function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单及模板数据成功',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单及模板数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:500,msg:'暂无订单及模板数据',results:res1}));              }          }      })  })  // 获取所有订单状态列表(根据时间段查询)  app.get([frontRequestUrl+'/listAllIndentStatusByDate', frontRequestUrl+'/listIndentById'],function(req,res){      var userName = req.query.keyword?req.query.keyword:'';      var startDate = req.query.startDate?req.query.startDate:'';      var endDate = req.query.endDate?req.query.endDate:'';      var id = req.query.id?req.query.id:'';      var erp = req.query.erp?req.query.erp:'';      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      // id,name,erp,materialCode,materialName,userName as duty,`procedure`, status      var sqlQuest = '';var sqlParam = '';      if(id){        sqlQuest = 'select * from `procedure` left join user on duty=user.userID inner join indent on a.indentID = indent.id where id = "'+req.query.id+'"  ifDelete = 0 order by indentID';      }else if(erp){        sqlQuest = 'select * from `procedure` left join user on duty=user.userID inner join indent on a.indentID = indent.id where erp = ? and ifDelete = 0 order by indentID';        sqlParam = [erp];      }else if(startDate){        // sqlQuest = 'select a.*, indent.erp, indent.ifNew, indent.priority, user.userName as duty from `procedure` a inner join indent on a.indentID = indent.id  left join user on a.duty = user.userID where (indent.planOnline >= ? and indent.planOnline <= ?) and ifDelete = 0 order by indentID';        sqlQuest = 'select  a.*,a.name as `procedure`, indent.erp, indent.planNum, indent.planOnline, indent.planFinishDate, indent.actualStart, indent.actualFinish, indent.ifNew, indent.priority, indent.templateID, user.userName as duty from `procedure` a inner join indent on a.indentID = indent.id left join user on a.duty = user.userID where  (indent.planOnline >= ? and indent.planOnline <= ?) and ifDelete = 0 order by indentID';        sqlParam = [startDate.replace(/-/g,'.'), endDate.replace(/-/g,'.')];      }else{        sqlQuest = 'select  a.*, a.name as `procedure`, indent.erp, indent.planNum, indent.planOnline, indent.planFinishDate, indent.actualStart, indent.actualFinish, indent.ifNew, indent.priority, indent.templateID, user.userName as duty from `procedure` a inner join indent on a.indentID = indent.id left join user on a.duty = user.userID where ifDelete = 0 order by indentID';        // select userName as duty,a.* from `procedure` a inner join indent on a.indentID = indent.id left join user on a.duty = user.userID      }      connection.query(sqlQuest, sqlParam, function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单状态失败',results:res1}));          }else{            // console.log(res1);              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单状态成功',results:res1}));              }else{                  res.send(JSON.stringify({code:200,msg:'暂无订单信息',results:res1}));              }          }      })  })  // 获取生产面板的订单数据(根据时间段查询)  app.get([frontRequestUrl+'/listShowPageData'],function(req,res){      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      // id,name,erp,materialCode,materialName,userName as duty,`procedure`, status      // var sqlQuest = 'select DISTINCT * from indent a left join `procedure` b on a.id = b.indentID where b.status != 0 GROUP BY a.id';      var sqlQuest = 'select DISTINCT c.userName as duty,b.*,a.erp, a.planNum, a.actualStart,a.planFinishDate,a.ifNew,a.priority from indent a left join `procedure` b on a.id = b.indentID LEFT JOIN user c on b.duty = c.userID  where a.ifDelete = 0 GROUP BY a.id';      connection.query(sqlQuest, function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单状态失败',results:res1}));          }else{            // console.log(res1);              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单状态成功',results:res1}));              }else{                  res.send(JSON.stringify({code:200,msg:'暂无订单信息',results:res1}));              }          }      })  })}module.exports = indent;