/** 订单功能*/function verifyUse(str){    if(str){        return str;    }else{        return '';    }}const indent = (app,multipartMiddleware,fs,moment,connection,uploadFile, xlsx) =>{  var frontRequestUrl = "/produceMS";  // 填充权重因子  var countFactor = (date)=>{    var defaultFactor = 41;    var year = moment().format('YYYY');    var month = moment().format('MM');    if(date){      year = moment(new Date(date)).format('YYYY');      month = moment(new Date(date)).format('MM');    }    var sqlQuest = 'select * from factor where year = ? and month = ?';    // var sqlParam = [parse.status, parse.remark, finishTime, parse.id];    var sqlParam = [year, month];    connection.query(sqlQuest,sqlParam,function(error,res1){        if(error){            console.log(error);        }else{          if(!res1.length){              var sqlQuest = 'insert into  factor(year, month, factor) values(?, ?, ?)';              // var sqlParam = [parse.status, parse.remark, finishTime, parse.id];              var sqlParam = [year, month, defaultFactor];              connection.query(sqlQuest,sqlParam,function(error,res1){                  if(error){                      console.log(error);                  }else{                    console.log(year, month, defaultFactor+'权重创建完成');                  }              })          }else{            // console.log(year, month, defaultFactor+'权重已存在');          }        }    })  }  // 填充近一年的权重  /*for(var i = 0;i<12;i++){    var time = new Date()-(i+1)*1000*60*60*24*30;    countFactor(new Date(time));  }*/  // 上传excel文件新增订单  app.post(frontRequestUrl+'/uploadExcelForAddIndent', multipartMiddleware,function(req,res){      var file = req.files.file;      var userID = req.body.id;      // console.log(file,req.body);      var nextFun = (file_path) =>{          var sheets = xlsx.parse(file_path);//获取到所有sheet          var sheet = sheets[0];          var total=success=fail=0;//数据统计          var importDataLen = sheet['data'].length - 1;          var totalError = {type:0, data:[], message:'的模板不存在'};          sheet['data'] = sheet['data'].filter(self=>{return self.length!=0});          for(let rowId in sheet['data']){              var row=sheet['data'][rowId];              if(rowId==0)continue;              var procedure = duty ='';              if(row.length){                // console.log(rowId, row);                var row_dir = row;                var sqlQuest0 = "select * from template where id = '"+row[row.length-1]+"'";                // 查询对应的模板是否存在                connection.query(sqlQuest0,function(error,res0){                  row = row_dir;                  // console.log(row);                  if(error){                    console.log(error);totalError.data.push(row[row.length-1]);return;                  }                  if(res0.length){                    total++;                    // console.log(res0[0].duty.split(' '));                    var procedureArr = res0[0].procedure.split(' ');                    var userArr = res0[0].duty.split(' ');                    // 添加订单记录                    var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planOnline,actualStart,priority,ifNew,remark,templateID,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                    // var sqlQuest2 = "insert into indent(name,erp, materialCode,materialName,planNum,planFinishDate,planOnline,actualStart,priority,ifNew,remark,templateID,procedure,duty,ifOutsource,feedback,status) values(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";                    var sqlParam2 = [res0.name, row[0], row[1], row[2], row[3], row[4].replace(/-/g,'.'), row[5].replace(/-/g,'.'), row[6].replace(/-/g,'.'), row[7].replace(/-/g,'.'), row[8], row[9], row[10],0];                    // 根据订单开始时间设置权重                    countFactor( row[6].replace(/-/g,'.'));                    connection.query(sqlQuest2,sqlParam2,function(error,res1){                      if(error){                        console.log(error);                      }else{                          // 添加流程记录                          for(let i = 0,len = procedureArr.length;i < len;i++){                              var sqlQuest3 = "insert into `procedure`(indentID, name, materialCode,materialName,duty,status) values(?, ?, ?, ?, ?, ?)";                              var sqlParam3 = [res1.insertId, procedureArr[i], row[2], row[3], userArr[i], 0];                              connection.query(sqlQuest3,sqlParam3,function(error,res1){                                if(error){                                  console.log(error);                                }else{                                }                                  console.log(row);                                // console.log('row打印:'+rowId,row.length);                                  if(rowId == sheet['data'].length-1){                                    if(i == procedureArr.length-1){                                      // console.log(procedureArr.length-1, i);                                      return;                                      success++;                                      var info = totalError.data.length?('编号为'+totalError.data.join()+'的'+totalError.data.length+'个模板不存在，请检查重试'):''                                      res.send(JSON.stringify({code:200,'msg':'新增订单成功', results: {total: total,success: success, fail: fail,info: info}}));                                    }                                  }                              })                          }                        }                      })                  }                })              }          }      }      uploadFile.storageFile(file,fs,moment,connection,userID,nextFun);  })  /*    // 删除订单信息    app.post(frontRequestUrl+'/deleteSystemUser',function(req,res){        var parse = req.body;        var sqlQuest = "delete from user where userID = '"+parse.userID+"'";        connection.query(sqlQuest,function(error,res1){            if(error){                console.log(error);                res.send(JSON.stringify({code:500,'msg':'删除订单失败'}));            }else{                res.send(JSON.stringify({code:200,'msg':'删除订单成功'}));            }      })  })*/  // 获取所有订单列表(根据时间段查询、erp查询、id查询)  app.get([frontRequestUrl+'/listAllIndentByDate', frontRequestUrl+'/listAllIndentById'],function(req,res){      var startDate = req.query.startDate?req.query.startDate:'';      var endDate = req.query.endDate?req.query.endDate:'';      var id = req.query.id?req.query.id:'';      var erp = req.query.erp?req.query.erp:'';      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      var sqlQuest = '';var sqlParam = '';      if(id){        sqlQuest = 'select * from `procedure` a left join indent b on a.indentID = b.id where b.id=?';// where userName like "%'+userName+'%"';        sqlParam = [id]      }else if(erp){        sqlQuest = 'select * from `procedure` a left join indent b on a.indentID = b.id where b.erp = ?';// where userName like "%'+userName+'%"';        sqlParam = [erp]      }else if(startDate){        sqlQuest = 'select * from `procedure` a left join indent b on a.indentID = b.id where planOnline >= ? and planOnline <= ?';// where userName like "%'+userName+'%"';        sqlParam = [startDate.replace(/-/g,'.'), endDate.replace(/-/g,'.')];      }else{        sqlQuest = 'select * from `procedure` a left join indent b on a.indentID = b.id';      }      connection.query(sqlQuest,sqlParam,function(error,res1,fileds){          console.log(sqlQuest, sqlParam);          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单数据失败',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:200,msg:'暂无订单信息',results:res1}));              }          }      })  })  // 获取订单及对应流程表  app.get([frontRequestUrl+'/listIndentMatchTemplete'],function(req,res){      var sqlQuest = 'select a.erp, a.materialCode, materialName, b.name ,GROUP_CONCAT(b.`procedure`),GROUP_CONCAT(b.duty) from indent a INNER JOIN template b where templateID = b.id GROUP BY a.id ORDER BY a.id';      connection.query(sqlQuest,function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单及模板数据成功',results:res1}));          }else{              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单及模板数据成功',results:res1}));              }else{                  res.send(JSON.stringify({code:500,msg:'暂无订单及模板数据',results:res1}));              }          }      })  })  // 获取所有订单状态列表(根据时间段查询)  app.get([frontRequestUrl+'/listAllIndentStatusByDate', frontRequestUrl+'/listIndentById'],function(req,res){      var userName = req.query.keyword?req.query.keyword:'';      var startDate = req.query.startDate?req.query.startDate:'';      var endDate = req.query.endDate?req.query.endDate:'';      var id = req.query.id?req.query.id:'';      var erp = req.query.erp?req.query.erp:'';      // var sqlQuest = 'select * from indent';// where userName like "%'+userName+'%"';      // id,name,erp,materialCode,materialName,userName as duty,`procedure`, status      var sqlQuest = '';var sqlParam = '';      if(id){        sqlQuest = 'select * from `procedure` left join user on duty=user.userID left join indent on a.indentID = indent.id where id = "'+req.query.id+'"';      }else if(erp){        sqlQuest = 'select * from `procedure` left join user on duty=user.userID left join indent on a.indentID = indent.id where erp = ?';        sqlParam = [erp];      }else if(startDate){        sqlQuest = 'select a.*, indent.erp, user.userName as duty from `procedure` a left join indent on a.indentID = indent.id  left join user on a.duty = user.userID where indent.planOnline >= ? and indent.planOnline <= ?';        sqlParam = [startDate.replace(/-/g,'.'), endDate.replace(/-/g,'.')];      }else{        sqlQuest = 'select  a.*, indent.erp, user.userName as duty from `procedure` a left join indent on a.indentID = indent.id left join user on a.duty = user.userID';        // select userName as duty,a.* from `procedure` a left join indent on a.indentID = indent.id left join user on a.duty = user.userID      }      connection.query(sqlQuest, sqlParam, function(error,res1,fileds){          if(error){              console.log(error);              res.send(JSON.stringify({code:500,msg:'查询订单状态失败',results:res1}));          }else{            // console.log(res1);              if(res1.length){                  res.send(JSON.stringify({code:200,msg:'查询订单状态成功',results:res1}));              }else{                  res.send(JSON.stringify({code:200,msg:'暂无订单信息',results:res1}));              }          }      })  })}module.exports = indent;